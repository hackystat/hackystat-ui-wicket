<project name="junit" default="junit">
  <description>
  Provides the JUnit tool and the Hackystat JUnit sensor.
  </description>

  <import file="build.xml" />
  <property name="junit.dir" location="${build.dir}/junit" />

  <target name="junit" depends="junit.tool, junit.report, junit.sensor" description="Runs JUnit, JunitReport">
    <fail if="junit.failed">JUnit test case(s) failed.</fail>
  </target>

  <target name="junit.tool" depends="compile" description="Run JUnit tests.">
    <mkdir dir="${junit.dir}" />
    <!-- Run the tests, which are all classes whose name starts with 'Test'. -->
    <junit maxmemory="512M" printsummary="withOutAndErr" haltonfailure="${junit.haltonfailure}" fork="yes" failureproperty="junit.failed">
      <jvmarg value="-Dsensorbaseclient.timeout=1000000"/>
      <jvmarg value="-Xmx512m"/>
      <classpath>
        <path refid="run.classpath" />
        <fileset file="${env.JAVAMAIL_HOME}/mail.jar"/> 
      </classpath>
      <sysproperty key="user.dir" value="${basedir}" />
      <sysproperty key="HACKYSTAT_SENSORBASE_HOME" value="${env.HACKYSTAT_SENSORBASE_HOME}" />
      <sysproperty key="HACKYSTAT_TELEMETRY_HOME" value="${env.HACKYSTAT_TELEMETRY_HOME}" />
      <sysproperty key="sensorbaseclient.timeout" value="1000000" />
      <formatter type="xml" />
      <batchtest todir="${junit.dir}">
        <fileset dir="${src.dir}" includes="**/Test*.java" />
      </batchtest>
    </junit>
  </target>

  <target name="junit.report" description="Generates an HTML report for JUnit.">
    <taskdef name="junitreport" classname="org.apache.tools.ant.taskdefs.optional.junit.XMLResultAggregator" />
    <junitreport todir="${junit.dir}">
      <fileset dir="${junit.dir}" includes="TEST-*.xml" />
      <report format="frames" todir="${junit.dir}" />
    </junitreport>
  </target>

  <target name="junit.sensor" description="Send hackystat data about this JUnit invocation." if="hackystat.enabled">
    <fileset id="junit.datafiles" dir="${junit.dir}" includes="TEST-*.xml" />
    <fileset id="junit.sourcefiles" dir="${src.dir}" includes="**/Test*.java" />
    <hackystat.junit junit.sourcefiles.fileset="junit.sourcefiles" junit.datafiles.fileset="junit.datafiles" verbose="${hackystat.verbose.mode}" />
  </target>


</project>



